<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    
    .line {
		fill: none;
		stroke: black;
		stroke-width: 1.5px;
    }
    
    .axis_title {
		font-weight: bold;
		font-family: Arial;
		font-size: 10pt;
    }
    
    #tooltip {
      	font-weight: bold;
        color: #222;
        background-color: rgba(255,255,255,.9);
      
        padding: .5em .5em .3em 0;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 5px;
		border: solid 2px;
        position: absolute;
    }
	#tooltip .title {
		text-align: center;
		font-size: large;
		font-weight: bold;
		font-family: Arial;
		
		border-bottom: solid 2px;
		padding-bottom: 5px;
		margin-bottom: 5px;
		margin-left: .5em;
	}
    
    .hidden {
        display: none;
    }
	
	.icon {
		width: 30px;
		text-align: center;
		padding: 4px 0px 4px 0px;
	}
  </style>
</head>

<body>
  <script>
    //Marges
    var margin = {top: 20, right: 30, bottom: 30, left: 40},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    //Canvas SVG dans lequel dessiner les graphiques
    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
    //Formatage
    var parseDate = d3.timeParse("%Y-%m");
    var displayMonth = d3.timeFormat("%m");
	var displayYear = d3.timeFormat("%Y");
    var displayValue = d3.format(",.0f");
	
	var frenchMonths = ["Janvier", "Février",  "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
    
    //Echelle temporelle
    var x = d3.scaleTime()
        			.range([0, width - 30]);
    var xAxis = d3.axisBottom()
        			.scale(x);
		
	//Echelle linéaire
    var y = d3.scaleLinear()
        			.range([height, height - 400]);
    var yAxis = d3.axisLeft()
        			.scale(y);

    //Noms des axes
    svg.append("text")
      .attr("x", -25)
      .attr("y", 30)
	  .attr("class", "axis_title")
      .text("Températures (en °C)");
    svg.append("text")
      .attr("x", width - margin.right * 2.6)
      .attr("y", height - margin.bottom / 2)
	  .attr("class", "axis_title")
      .text("Années");

    //Div qui servira de tooltip
    var tooltip = d3.select("body").append("div")
        .attr("id", "tooltip")
        .attr("class", "hidden");
    
    // Préparation des lignes entre les données
    var line = d3.line()
        .x(function(d) { return x(d.date); })
        .y(function(d) { return y(d.value); })
    	.curve(d3.curveBasis);
    
    
	
	//Blind frendly. Photocopy, LCD and print friendly
	var red = "#de2d26";
	var green = "#31a354";
	var meanTemp;
	
    //Gestion des données de températures
	d3.json("./data/temp_test.json", function(data) {
      
	  meanTemp = mean(data);
	  
	  //Formatage d'une partie des données
      data.forEach(function(d) {
        d.date = parseDate(d.date);
      });
      
      //Ajustement des échelles
      x.domain(d3.extent(data, function(d) { return d.date; }));
	  y.domain([0, d3.max(data, function(d) { return d.value; })]);

      //Affichage des lignes
      svg.selectAll("path").data([data]).enter().append("path")
        .attr("class", "line")
        .attr("d", line);
  
      //Mise à jour des axes
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);
      svg.append("g")
        .attr("transform", "translate(0,0)")
      	.call(yAxis);
	
	
	  //Placement de la ligne de température moyenne
	  svg.append("g")
        .attr("transform", "translate(0, " + y(meanTemp) + ")")
        .append("line")
        .attr("x2", width - margin.right)
        .style("stroke", "#aaa")
        .style("stroke-width", "2px");
    });
    
    
	
    //Gestion des données relatives aux ouragans, tornades...
	d3.json("./data/tornadoes_test.json", function(data) {

      //Formatage des dates pour affichage
      data.forEach(function(d) {
        d.date_start = parseDate(d.date_start);
		d.date_end = parseDate(d.date_end);
		
		let month_start = frenchMonths[parseInt(displayMonth(d.date_start)) - 1];
		let month_end = frenchMonths[parseInt(displayMonth(d.date_end)) - 1];
		let year_start = displayYear(d.date_start);
		let year_end = displayYear(d.date_end);
		
		d.full_date_start = month_start + " " + year_start;
		d.full_date_end = month_end + " " + year_end;
      });
      
      //Ajustement des échelles
      x.domain(d3.extent(data, function(d) { return d.date_start; }));
	  y.domain([0, d3.max(data, function(d) { return d.value; })]);

      //Affichage des cercles
      svg.selectAll("circle").data(data).enter()
        .append("circle")
		.style("fill", function(d) { return d.value < meanTemp ? green : red; })
        .style("stroke", "black")
        .attr("r", function(d) { return d.intensity * 1.5; })
        .attr("cx", function(d) { return x(d.date_start); })
        .attr("cy", function(d) { return y(d.value); })
      	
        .on("mousemove", function(d) {
          //Coordonnées du curseur
          var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
		  
		  //Choix du placement du tooltip (gauche/droite)
		  if (mouse[0] + 70 < 800) {
			var mouseX = mouse[0] + 70
		  } else {
			var mouseX = mouse[0] - 100
		  }

          //Apparition et placement
          tooltip.classed("hidden", false)
            .attr("style", "left:" + mouseX + "px; " +
                  "top:" + (mouse[1] - 35) + "px")
          	.html('<div class="title">' + d.name + '</div>' + 
                  '<div><i class="far fa-calendar icon"></i>' + d.full_date_start + '</div>' +
                  '<div><i class="far fa-calendar-times icon"></i>' + d.full_date_end + '</div>' +
                  '<div><i class="fas fa-cloud-showers-heavy icon"></i>' + d.intensity + '</div>' +
                  '<div><i class="fas fa-skull-crossbones icon"></i>' + d.death + '</div>' +
                  '<div><i class="fas fa-dollar-sign icon"></i>' + d.cost) + '</div>';
        })

      	//Disparition du tooltip
        .on("mouseout", function() {
          tooltip.classed("hidden", true);
        });
  
      //Mise à jour des axes
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);
      svg.append("g")
        .attr("transform", "translate(0,0)")
      	.call(yAxis);
    });
	
	
	
	
	
	//Calcule la moyenne des valeurs de l'attribut 'value'
	//de l'objet JSON passé en param (températures)
	function mean(dataset) {
		var total = 0;
		
		dataset.forEach(function(d) {
			total += d.value;
		});
		
		return total / Object.keys(dataset).length;
	}
    
  </script>
</body>
